# Автоматизация сбора и импорта продаж

Данный репозиторий содержит полностью автоматизированный пайплайн обработки данных о продажах для крупной розничной сети, торгующей товарами для дома (бытовая химия, текстиль, кухонная утварь и др.).

В рамках бизнес-процесса кассовое программное обеспечение ежедневно выгружает CSV-файлы с информацией о чеках и продажах в выделенную директорию на сервере. Проект автоматизирует дальнейшую работу с этими данными: от эмуляции выгрузок до обработки, агрегации и подготовки данных для аналитики.

Репозиторий самодостаточен: содержит код, структуру данных и инструкции, необходимые для запуска проекта в локальной среде или на сервере без дополнительной настройки.

Ниже вы найдете всю необходимую информацию для того, чтобы запустить проект на новой машине.

## Важно

Перед запуском убедитесь, что у вас установлены:
1.  **Python 3.8+**
2.  **PostgreSQL** (локально или доступ к удаленному серверу)

---

## Установка и настройка

### Шаг 1. Структура проекта
Убедитесь, что в папке проекта (например, `shop_project`) находятся следующие файлы:

1.  **Python скрипты:**
    *   `generate_sales.py` — Генерация чеков.
    *   `postgr_data.py` — Импорт в базу данных.
2.  **Shell скрипты (менеджеры запуска):**
    *   `run_gen.sh` — Запускает генерацию.
    *   `run_import.sh` — Запускает импорт.
3.  **Папки:**
    *   `data/` — Сюда падают csv файлы.
    *   `logs/` — (Опционально) для хранения логов.

### Шаг 2. Настройка Базы Данных
1. Зайдите в PostgreSQL (через pgAdmin или терминал) и создайте базу данных (если нет).
2. Выполните SQL-запрос для создания таблицы из файла DDL
   ```bash
   CREATE TABLE IF NOT EXISTS data_shops (
    id SERIAL PRIMARY KEY,
    doc_id VARCHAR(50) NOT NULL,
    shop_id INTEGER NOT NULL,
    cash_id INTEGER NOT NULL,
    item_name VARCHAR(255) NOT NULL,
    category VARCHAR(100),
    amount INTEGER NOT NULL,
    price NUMERIC(10, 2) NOT NULL,
    discount NUMERIC(10, 2) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
   );
    ```
3. Настройка подключения к БД (postgr_data.py). Откройте файл postgr_data.py и найдите блок конфигурации. Укажите свои данные:
```bash
DB_HOST = 'localhost'
DB_NAME = 'postgres'      # Имя вашей БД
DB_USER = 'postgres'      # Ваш логин
DB_PASS = 'ваш_пароль'    # Ваш пароль
 ```

### Шаг 2. Настройка Shell-скриптов

Вам нужно отредактировать пути в обоих `.sh` файлах под новую машину.

**Файл 1: `run_gen.sh`**
```bash
#!/bin/bash
cd "/Users/username/Documents/shop_project"
echo "Start Gen: $(date)" >> gen_log.txt
/usr/bin/python3 generate_sales.py >> gen_log.txt 2>&1
 ```

**Файл 2: run_import.sh**
```bash
#!/bin/bash
cd "/Users/username/Documents/shop_project"
echo "Start Import: $(date)" >> import_log.txt
/usr/bin/python3 import_db.py >> import_log.txt 2>&1
 ```

Не забудьте сделать их исполняемыми:
chmod +x run_gen.sh
chmod +x run_import.sh

---

### ⏰ Настройка расписания (Crontab)

Поскольку скрипты разделены, мы настроим их запуск с небольшим интервалом, чтобы генератор успел создать файлы до того, как импортер начнет их забирать.

Откройте редактор:
```bash
crontab -e
 ```

Добавьте две строки (пример сценария: генерация в начале часа, импорт через 5 минут):
```bash
text
# 1. Генерация данных (каждый час в 00 минут)
0 * * * * "/Users/username/Documents/shop_project/run_gen.sh"

# 2. Импорт данных в БД (каждый час в 05 минут)
5 * * * * "/Users/username/Documents/shop_project/run_import.sh"
Примеры расписаний:
 ```

**Примеры расписаний:**

Частое обновление:
- Генерация каждые 10 мин: */10 * * * * ...run_gen.sh
- Импорт каждые 10 мин (со сдвигом): 5-55/10 * * * * ...run_import.sh

Раз в сутки:
- Генерация в 23:00: 0 23 * * * ...
- Импорт в 23:30: 30 23 * * * ...

---

### ⚠️ Решение частых проблем

1. Скрипты не запускаются по расписанию:
- Проверьте, дали ли вы права на выполнение (chmod +x).
- Убедитесь, что в путях к папкам нет ошибок (особенно с кириллицей).
- На macOS проверьте "Full Disk Access" для процесса cron.

2. Логи пустые или содержат ошибки Python:
- Проверьте путь к интерпретатору в .sh файлах (/usr/bin/python3 или /usr/local/bin/python3).
- Убедитесь, что библиотека psycopg2 установлена для этого интерпретатора.






